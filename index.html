<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cek Jepang Indo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500&family=Poppins:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #17a2b8;
            --success-color: #28a745;
            --error-color: #dc3545;
            --light-gray: #f9f9f9;
            --dark-gray: #333;
            --border-color: #ddd;
        }
        body {
            font-family: 'Montserrat', sans-serif;
            background-color: var(--light-gray);
            color: var(--dark-gray);
            margin: 0;
            padding: 1rem;
            padding-top: 70px;
            -webkit-text-size-adjust: 100%;
        }

        .fixed-header {
            position: fixed; /* Membuat header tetap di posisinya */
            top: 0; /* Menempel di bagian atas */
            left: 0;
            width: 100%;
            background-color: #ffffff; /* Latar belakang putih */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Sedikit bayangan di bawah */
            padding: 10px 0;
            z-index: 1000; /* Memastikan header berada di atas elemen lain */
        }
        
        .header-content {
            max-width: 800px; /* Lebar konten sama dengan container Anda */
            margin: 0 auto;
            display: flex; /* Menggunakan flexbox untuk menata tombol */
            justify-content: center; /* Memusatkan tombol secara horizontal */
            gap: 20px; /* Jarak antar tombol */
        }
        
        .header-btn {
            padding: 8px 20px;
            border-radius: 5px;
            text-decoration: none;
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            color: white;
            transition: background-color 0.3s ease;
        }
        
        .blue-btn {
            background-color: #007bff; /* Biru */
        }
        
        .blue-btn:hover {
            background-color: #0056b3; /* Biru lebih gelap saat hover */
        }
        
        .green-btn {
            background-color: #28a745; /* Hijau */
        }
        
        .green-btn:hover {
            background-color: #1e7e34; /* Hijau lebih gelap saat hover */
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        h1 { /* Mengganti h2 menjadi h1 untuk judul utama */
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            text-align: center;
            font-size: 1.5rem;
            color: var(--dark-gray);
        }
        .input-group {
            margin-bottom: 1.25rem;
        }
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        input[type="text"], input[type="tel"], textarea, input[type="file"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: 'Montserrat', sans-serif;
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        input[type="file"] {
            padding: 0.5rem;
        }
        .submit-btn {
            width: 100%;
            padding: 1rem;
            border: none;
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            font-size: 1.1rem;
            cursor: pointer;
            text-align: center;
            text-decoration: none;
            display: block;
            box-sizing: border-box;
            background-color: var(--primary-color);
            color: white;
            transition: background-color 0.3s ease;
        }
        .submit-btn:hover:not(:disabled) {
            background-color: #138496;
        }
        .submit-btn:disabled {
            background-color: #a0a0a0;
            cursor: not-allowed;
        }
        #preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        #preview-container img {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        #progressBarContainer {
            width: 100%;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 1.25rem;
            display: none; /* Sembunyi secara default */
        }
        #progressBar {
            width: 0%;
            height: 25px;
            background-color: var(--success-color);
            border-radius: 5px;
            text-align: center;
            line-height: 25px;
            color: white;
            font-size: 14px;
            transition: width 0.3s ease;
        }
        #status {
            text-align: center;
            margin-top: 15px;
            font-weight: 500;
        }
        .whatsapp-btn {
            display: none; /* Sembunyi secara default */
            margin-top: 15px;
            padding: 10px 20px;
            background-color: var(--success-color);
            color: #fff;
            text-decoration: none;
            border-radius: 5px;
            font-family: 'Poppins', sans-serif;
            text-align: center;
        }
    </style>
</head>
<body>

<header class="fixed-header">
    <div class="header-content">
        <a href="https://cekbarang.netlify.app/" class="header-btn blue-btn">Home</a>
        <a href="https://docs.google.com/spreadsheets/d/15CtlzSn56c1oTL_FhayaumWPb6ZVXlE4b7GZ040_QH0/edit?gid=1011295621#gid=1011295621" class="header-btn green-btn">Spreadsheet</a>
    </div>
</header>
    
<div class="container">
    <h1>Form Cek Barang Jepang-Indo</h1>
    <form id="submissionForm">
        <div class="input-group">
            <label for="nama">Nama</label>
            <input type="text" id="nama" name="nama">
        </div>
        <div class="input-group">
            <label for="whatsapp">Nomor WhatsApp</label>
            <input type="tel" id="whatsapp" name="whatsapp" placeholder="Contoh: 08123456789">
        </div>
        <div class="input-group">
            <label for="list-Barang">List Barang</label>
            <textarea id="list-Barang" name="listBarang"></textarea>
        </div>
        <div class="input-group">
            <label for="berat-bagasi">Berat Bagasi (kg)</label>
            <input type="tel" id="berat-bagasi" name="beratBagasi" placeholder="angka saja, contoh: 5">
        </div>
        <div class="input-group">
            <label for="berat-kabin">Berat Kabin (kg)</label>
            <input type="tel" id="berat-kabin" name="beratKabin" placeholder="angka saja, contoh: 5">
        </div>
        <div class="input-group">
            <label for="berat-khusus">Berat Khusus (kg)</label>
            <input type="tel" id="berat-khusus" name="beratKhusus" placeholder="angka saja, contoh: 5">
        </div>
        <div class="input-group">
            <label for="berat-total">Berat Total (kg)</label>
            <input type="tel" id="berat-total" name="beratTotal" readonly>
        </div>
        <div class="input-group">
            <label for="total-packing">Jumlah Packingan</label>
            <input type="tel" id="total-packing" name="jumlahPack" placeholder="angka saja, contoh: 5">
        </div>
        <div class="input-group">
            <label for="foto">Foto Barang (maks. 10 foto)</label>
            <input type="file" id="foto" name="foto" multiple accept="image/*">
            <div id="preview-container"></div>
        </div>
        <div class="input-group">
            <label>Status Kelengkapan Barang</label>
            <label style="display: inline-flex; align-items: center; margin-right: 15px; font-weight: normal;">
                <input type="radio" name="kelengkapanStatus" value="Lengkap" style="width: auto; margin-right: 8px;"> Lengkap
            </label>
            <label style="display: inline-flex; align-items: center; font-weight: normal;">
                <input type="radio" name="kelengkapanStatus" value="Belum Lengkap" style="width: auto; margin-right: 8px;"> Belum Lengkap
            </label>
        </div>
        <button type="submit" class="submit-btn" id="submit-btn">Kirim Data</button>
        
        <div id="progressBarContainer">
            <div id="progressBar">0%</div>
        </div>
        <div id="status"></div>
        <a href="#" id="whatsapp-btn" class="whatsapp-btn" target="_blank">Kirim ke WhatsApp</a>

    </form>
</div>

<script>
    // ================================================================
    // === DEKLARASI VARIABEL GLOBAL ===
    // ================================================================
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzM-L07JAhouNd5SZ0a7ed4mUxhjCnE3WX0q3Q_KiACu16zxRRpWhgijw2HIRu-u7dE/exec';
    const STORAGE_KEY = 'formData';

    const form = document.getElementById('submissionForm');
    const namaInput = document.getElementById('nama');
    const waInput = document.getElementById('whatsapp');
    const bagasiInput = document.getElementById('berat-bagasi');
    const kabinInput = document.getElementById('berat-kabin');
    const khususInput = document.getElementById('berat-khusus');
    const totalInput = document.getElementById('berat-total');
    const packInput = document.getElementById('total-packing');
    const fotoInput = document.getElementById('foto');
    const previewContainer = document.getElementById('preview-container');
    const submitBtn = document.getElementById('submit-btn');
    const progressBarContainer = document.getElementById('progressBarContainer');
    const progressBar = document.getElementById('progressBar');
    const statusDiv = document.getElementById('status');
    const whatsappBtn = document.getElementById('whatsapp-btn');

    // ================================================================
    // === FUNGSI-FUNGSI BANTU ===
    // ================================================================

    function saveFormData() {
        const fileList = [];
        for (const file of fotoInput.files) {
            fileList.push({ name: file.name, size: file.size });
        }
        const data = {
            nama: namaInput.value,
            whatsapp: waInput.value,
            listBarang: document.getElementById('list-Barang').value,
            beratBagasi: bagasiInput.value,
            beratKabin: kabinInput.value,
            beratKhusus: khususInput.value,
            beratTotal: totalInput.value,
            jumlahPack: packInput.value,
            kelengkapanStatus: document.querySelector('input[name="kelengkapanStatus"]:checked')?.value || '',
            fileInfo: fileList
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function loadFormData() {
        const savedData = localStorage.getItem(STORAGE_KEY);
        if (savedData) {
            const data = JSON.parse(savedData);
            namaInput.value = data.nama || '';
            waInput.value = data.whatsapp || '';
            document.getElementById('list-Barang').value = data.listBarang || '';
            bagasiInput.value = data.beratBagasi || '';
            kabinInput.value = data.beratKabin || '';
            khususInput.value = data.beratKhusus || '';
            totalInput.value = data.beratTotal || '';
            packInput.value = data.jumlahPack || '';
            if (data.kelengkapanStatus) {
                document.querySelector(`input[name="kelengkapanStatus"][value="${data.kelengkapanStatus}"]`).checked = true;
            }
            if (data.fileInfo && data.fileInfo.length > 0) {
                const fileReminder = document.createElement('div');
                fileReminder.style.cssText = 'margin-top: 10px; padding: 10px; background-color: #f0f0f0; border: 1px dashed #ccc; border-radius: 5px;';
                let fileNames = data.fileInfo.map(f => f.name).join(', ');
                fileReminder.innerHTML = `<strong>File sebelumnya:</strong> ${fileNames}. <br/><small>Silakan pilih ulang file-file ini.</small>`;
                fotoInput.parentElement.insertBefore(fileReminder, previewContainer);
            }
        }
    }

    function clearFormData() {
        localStorage.removeItem(STORAGE_KEY);
    }

    const handleBeforeUnload = (event) => {
        event.preventDefault();
        event.returnValue = '';
    };

    const updateBeratTotal = () => {
        const bagasi = parseFloat(bagasiInput.value) || 0;
        const kabin = parseFloat(kabinInput.value) || 0;
        const khusus = parseFloat(khususInput.value) || 0;
        totalInput.value = bagasi + kabin + khusus;
    };

    function compressImage(file, maxSizeKB = 300) {
        return new Promise((resolve, reject) => {
            const fileSizeKB = file.size / 1024;
            if (fileSizeKB <= maxSizeKB) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                return;
            }
            const image = new Image();
            image.src = URL.createObjectURL(file);
            image.onload = () => {
                const canvas = document.createElement('canvas');
                const maxWidth = 1024;
                const scaleSize = maxWidth / image.width;
                canvas.width = maxWidth;
                canvas.height = image.height * scaleSize;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
                const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
                URL.revokeObjectURL(image.src);
                resolve(compressedBase64);
            };
            image.onerror = error => reject(error);
        });
    }

    // ================================================================
    // === EVENT LISTENERS ===
    // ================================================================

    document.addEventListener('DOMContentLoaded', loadFormData);
    form.addEventListener('input', saveFormData);
    window.addEventListener('beforeunload', handleBeforeUnload);
    form.addEventListener('input', () => { window.addEventListener('beforeunload', handleBeforeUnload); });
    [bagasiInput, kabinInput, khususInput].forEach(input => input.addEventListener('input', updateBeratTotal));

    fotoInput.addEventListener('change', (e) => {
        previewContainer.innerHTML = '';
        const files = e.target.files;
        if (files.length > 10) {
            alert('Maksimal 10 foto.');
            fotoInput.value = ''; return;
        }
        for (const file of files) {
            const reader = new FileReader();
            reader.onload = (event) => {
                const img = document.createElement('img');
                img.src = event.target.result;
                previewContainer.appendChild(img);
            };
            reader.readAsDataURL(file);
        }
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerText = 'Mengirim...';
        statusDiv.innerText = '';
        whatsappBtn.style.display = 'none';
        progressBarContainer.style.display = 'block';
        progressBar.style.width = '10%';
        progressBar.innerText = 'Mempersiapkan data...';
        
        try {
            const files = fotoInput.files;
            if (files.length === 0) {
                alert('Harap pilih setidaknya satu foto.');
                throw new Error("Tidak ada file dipilih.");
            }

            const textData = {
                nama: namaInput.value,
                whatsapp: waInput.value,
                listBarang: document.getElementById('list-Barang').value,
                beratBagasi: bagasiInput.value,
                beratKabin: kabinInput.value,
                beratKhusus: khususInput.value,
                beratTotal: totalInput.value,
                jumlahPack: packInput.value,
                kelengkapanStatus: document.querySelector('input[name="kelengkapanStatus"]:checked')?.value || 'Tidak diisi'
            };
        
            const fileData = [];
            for (let i = 0; i < files.length; i++) {
                const progress = 10 + (40 / files.length * (i + 1));
                progressBar.style.width = `${progress}%`;
                progressBar.innerText = `Memproses file ${i + 1} dari ${files.length}...`;
                const compressedContent = await compressImage(files[i], 300);
                fileData.push({
                    fileName: files[i].name,
                    mimeType: 'image/jpeg',
                    content: compressedContent
                });
            }

            const payload = { ...textData, files: fileData };
        
            progressBar.style.width = '50%';
            progressBar.innerText = 'Mengunggah file...';

            const response = await fetch(SCRIPT_URL, {
                method: 'POST',
                redirect: "follow",
                headers: { "Content-Type": "text/plain;charset=utf-8" },
                body: JSON.stringify(payload)
            });
        
            progressBar.style.width = '80%';
            progressBar.innerText = 'Memproses data...';

            if (response.ok) {
                const result = await response.json();
                if (result.status === 'success') {
                    statusDiv.innerText = 'Data berhasil dikirim!';
                    statusDiv.style.color = 'var(--success-color)';
                    const namaKakak = result.nama;
                    const nomorWaBersih = result.whatsapp;
                    const urlFolderBaru = result.folderUrl;
                    const tanggalHariIni = new Date();
                    const options = { day: 'numeric', month: 'long', year: 'numeric' };
                    const tanggalFormatted = tanggalHariIni.toLocaleDateString('id-ID', options);
                    const whatsappMessage = `Hai kak ${namaKakak}, Barang kakak sudah kami terima dan sudah di cek per tanggal ${tanggalFormatted}. Semua foto barang kakak dapat dilihat di folder ini ya: ${urlFolderBaru}`;
                    const encodedMessage = encodeURIComponent(whatsappMessage);
                    const whatsappLink = `https://wa.me/${nomorWaBersih}?text=${encodedMessage}`;
                    whatsappBtn.href = whatsappLink;
                    whatsappBtn.style.display = 'block';
                    form.reset();
                    previewContainer.innerHTML = '';
                    clearFormData();
                    window.removeEventListener('beforeunload', handleBeforeUnload);
                    const fileReminder = fotoInput.parentElement.querySelector('div[style*="margin-top: 10px"]');
                    if (fileReminder) fileReminder.remove();
                } else {
                    throw new Error(result.message || 'Terjadi kesalahan di server.');
                }
            } else {
                throw new Error(`Gagal terhubung ke server (Status: ${response.status})`);
            }
            
            progressBar.style.width = '100%';
            progressBar.innerText = 'Selesai!';

        } catch (error) {
            statusDiv.innerText = `Error: ${error.message}`;
            statusDiv.style.color = 'var(--error-color)';
            progressBar.style.backgroundColor = 'var(--error-color)';
            progressBar.innerText = 'Gagal';
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = 'Kirim Data';
            setTimeout(() => {
                progressBarContainer.style.display = 'none';
                progressBar.style.width = '0%';
                progressBar.style.backgroundColor = 'var(--success-color)';
            }, 5000);
        }
    });
</script>

</body>
</html>
